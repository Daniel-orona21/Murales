<div class="mural-detail-container">
  <!-- Global loading spinner for images -->
  <div class="global-loading-container" *ngIf="isLoadingImages">
    <div class="pyramid-loader">
      <div class="wrapper">
        <span class="side side1"></span>
        <span class="side side2"></span>
        <span class="side side3"></span>
        <span class="side side4"></span>
        <span class="shadow"></span>
      </div>  
    </div>
    <div class="global-loading-text">Cargando publicaciones...</div>
  </div>

  <!-- Publicaciones container -->
  <div class="publicaciones-container">
    
    <div *ngIf="error" class="error-container">
      <p>{{ error }}</p>
      <button class="retry-button" (click)="cargarPublicaciones()">Reintentar</button>
    </div>
    
    <div *ngIf="!cargando && !error && publicaciones.length === 0" class="empty-state">
      <p>No hay publicaciones en este mural.</p>
      <p>¡Crea la primera publicación haciendo clic en el botón de agregar!</p>
    </div>
    
    <!-- Grid layout for publications -->
    <div #masonryGrid class="publicaciones-grid" [class.loaded]="!isLoadingImages">
      <div class="grid-sizer"></div>
      <div class="gutter-sizer"></div>
      <div class="publicacion-item" *ngFor="let publicacion of publicaciones; let i = index" (click)="openCarousel(i)">
        <div class="publicacion-header">
          <h3>{{ publicacion.titulo }}</h3>
          <div class="like-container" (click)="$event.stopPropagation()">
            <label class="container">
              <input type="checkbox" 
                     [checked]="userLikes[publicacion.id_publicacion]"
                     [disabled]="likesLoading[publicacion.id_publicacion]"
                     (change)="toggleLike(publicacion.id_publicacion)">
              <svg id="Layer_1" version="1.0" viewBox="0 0 24 24" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M16.4,4C14.6,4,13,4.9,12,6.3C11,4.9,9.4,4,7.6,4C4.5,4,2,6.5,2,9.6C2,14,12,22,12,22s10-8,10-12.4C22,6.5,19.5,4,16.4,4z"></path></svg>
            </label>
            <span class="likes-count" *ngIf="likesCount[publicacion.id_publicacion] > 0">
              {{ likesCount[publicacion.id_publicacion] }}
            </span>
          </div>
          <!-- <div class="publicacion-author">
            <span class="author-avatar" *ngIf="publicacion.avatar_url">
              <img [src]="publicacion.avatar_url" alt="Avatar">
            </span>
            <span class="author-name">{{ publicacion.nombre_usuario || 'Usuario' }}</span>
          </div> -->
        </div>
        
        <div class="publicacion-content">
          <div *ngIf="publicacion.contenido && publicacion.contenido.length > 0">
            <div *ngFor="let contenido of publicacion.contenido" class="contenido-item">
              <!-- Contenido tipo imagen -->
              <div *ngIf="contenido.tipo_contenido === 'imagen'" class="contenido-imagen">
                <img [src]="contenido.url_contenido" 
                     [alt]="contenido.nombre_archivo || 'Imagen'" 
                     class="imagen-preview"
                     (load)="onImageLoaded()"
                     (error)="onImageLoaded()">
              </div>
              
              <!-- Contenido tipo video -->
              <div *ngIf="contenido.tipo_contenido === 'video'" class="contenido-video" (click)="$event.stopPropagation()">
                <video controls 
                       class="video-preview" 
                       preload="auto"
                       poster
                       controlsList="nodownload" 
                       disablePictureInPicture
                       playsinline
                       crossorigin="anonymous"
                       (loadedmetadata)="onVideoLoaded($event)"
                       (error)="onImageLoaded()">
                  <source [src]="contenido.url_contenido" type="video/mp4">
                  Tu navegador no soporta la reproducción de video.
                </video>
              </div>
              
              <!-- Contenido tipo enlace -->
              <div *ngIf="contenido.tipo_contenido === 'enlace'" class="contenido-enlace">
                <ng-container *ngIf="isYouTubeLink(contenido.url_contenido ?? ''); else normalLink">
                  <div class="youtube-embed-container">
                    <iframe
                      [src]="getSafeYouTubeEmbedUrl(contenido.url_contenido ?? '')"
                      frameborder="0"
                      allowfullscreen
                      loading="lazy"
                      style="width: 100%; aspect-ratio: 16/9; min-height: none; border-radius: 8px; background: #000;">
                    </iframe>
                  </div>
                </ng-container>
                <ng-template #normalLink>
                  <span class="material-symbols-outlined">link</span>
                  <a [href]="contenido.url_contenido" target="_blank" rel="noopener noreferrer">
                    {{ contenido.url_contenido }}
                  </a>
                </ng-template>
              </div>
              
              <!-- Contenido tipo archivo -->
              <div *ngIf="contenido.tipo_contenido === 'archivo'" class="contenido-archivo">
                <ng-container *ngIf="isPDF(contenido.url_contenido ?? ''); else normalFile">
                  <div class="pdf-preview-container">
                    <ng-container *ngIf="!cargando && !isLoadingImages; else pdfPlaceholder">
                      <pdf-viewer
                        [src]="contenido.url_contenido"
                        [render-text]="true"
                        [original-size]="false"
                        [show-all]="true"
                        [fit-to-page]="true"
                        [zoom]="1"
                        [rotation]="0"
                        [page]="1"
                        [external-link-target]="'blank'"
                        [autoresize]="true"
                        [show-borders]="false"
                        class="pdf-preview">
                      </pdf-viewer>
                    </ng-container>
                    <ng-template #pdfPlaceholder>
                      <div class="pdf-placeholder"></div>
                    </ng-template>
                  </div>
                </ng-container>
                <ng-template #normalFile>
                  <span class="material-symbols-outlined">description</span>
                  <div class="archivo-info">
                    <a [href]="contenido.url_contenido" target="_blank" rel="noopener noreferrer" class="archivo-link">
                      <p class="archivo-nombre">{{ contenido.nombre_archivo }}</p>
                      <p class="archivo-tamano" *ngIf="contenido.tamano_archivo">
                        {{ formatFileSize(contenido.tamano_archivo) }}
                      </p>
                    </a>
                  </div>
                </ng-template>
              </div>

              <!-- Contenido tipo texto -->
              <div *ngIf="contenido.tipo_contenido === 'texto'" class="contenido-texto">
                <p class="texto-contenido">{{ contenido.texto }}</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- <div class="publicacion-footer">
          <span class="publicacion-fecha">{{ publicacion.fecha_creacion | date:'dd/MM/yyyy HH:mm' }}</span>
        </div> -->
      </div>
    </div>
  </div>

  <!-- Carousel component -->
  <app-publicacion-carousel
    *ngIf="showCarousel"
    [publicaciones]="publicaciones"
    [currentIndex]="selectedPublicacionIndex"
    [userLikes]="userLikes"
    [likesCount]="likesCount"
    [likesLoading]="likesLoading"
    [isAdmin]="isAdmin"
    (close)="closeCarousel()"
    (likeToggled)="onLikeToggled($event)"
    (commentAdded)="onCommentAdded($event)"
    (editPublicacion)="onEditPublicacion($event)"
    (deletePublicacion)="onDeletePublicacion($event)"
    (saveEdit)="onSaveEdit($event.publicacionId, $event.data)"
    (cancelEdit)="onCancelEdit()">
  </app-publicacion-carousel>

  <!-- Modal para agregar elementos -->
  <div class="modal-sidebar" [class.show]="showModal">
    <div class="modal-header">
      <h2>Agregar elemento</h2>
      <button class="close-button" (click)="toggleModal()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="modal-content">
      <div *ngIf="error" class="form-error">{{ error }}</div>
      
      <div class="form-group">
        <label for="titulo">Título</label>
        <input type="text" id="titulo" [(ngModel)]="nuevoElemento.titulo" placeholder="Añade un título">
      </div>
      
      <div class="form-group">
        <label for="descripcion">Descripción</label>
        <textarea id="descripcion" [(ngModel)]="nuevoElemento.descripcion" rows="3" placeholder="Añade una descripción"></textarea>
      </div>
      
      <div class="form-group">
        <label>Contenido</label>
        
        <div class="content-type-selector">
          <button 
            class="content-type-button" 
            [class.active]="contentType === 'nota'"
            (click)="setContentType('nota')">
            <span class="material-symbols-outlined">note</span>
            <span>Nota</span>
          </button>
          <button 
            class="content-type-button" 
            [class.active]="contentType === 'archivo'"
            (click)="setContentType('archivo')">
            <span class="material-symbols-outlined">upload_file</span>
            <span>Archivo</span>
          </button>
          <button 
            class="content-type-button" 
            [class.active]="contentType === 'link'"
            (click)="setContentType('link')">
            <span class="material-symbols-outlined">link</span>
            <span>Enlace</span>
          </button>
        </div>
        
        <!-- Sección de Nota -->
        <div class="note-container" *ngIf="contentType === 'nota'">
          <div class="form-group">
            <label for="note-content">Contenido de la nota</label>
            <textarea 
              id="note-content" 
              [(ngModel)]="nuevoElemento.nota" 
              rows="6" 
              placeholder="Escribe tu nota aquí..."
              class="note-textarea"></textarea>
          </div>
        </div>
        
        <!-- Sección de Archivo -->
        <div class="file-upload-container" 
             *ngIf="contentType === 'archivo'"
             [class.drag-over]="isDragging"
             (dragover)="onDragOver($event)" 
             (dragleave)="onDragLeave($event)" 
             (drop)="onDrop($event)">
          
          <div class="upload-area" *ngIf="!nuevoElemento.archivo">
            <span class="material-symbols-outlined upload-icon">cloud_upload</span>
            <p>Arrastra un archivo aquí o</p>
            <label class="upload-button">
              Seleccionar archivo
              <input type="file" (change)="onFileSelected($event)" hidden>
            </label>
          </div>
          
          <div class="file-preview" *ngIf="nuevoElemento.archivo">
            <div class="file-info">
              <span class="material-symbols-outlined file-icon">description</span>
              <div class="file-details">
                <p class="file-name">{{ nuevoElemento.archivo.name }}</p>
                <p class="file-size">{{ formatFileSize(nuevoElemento.archivo.size) }}</p>
              </div>
            </div>
            <button class="remove-file" (click)="removeFile()">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
        
        <!-- Sección de Link -->
        <div class="link-container" *ngIf="contentType === 'link'">
          <div class="form-group">
            <label for="link-url">URL del enlace</label>
            <input 
              type="url" 
              id="link-url" 
              [(ngModel)]="nuevoElemento.link" 
              placeholder="https://ejemplo.com"
              pattern="https?://.+"
              title="Incluye http:// o https://">
          </div>
          
          <div class="link-preview" *ngIf="nuevoElemento.link">
            <div class="link-info">
              <span class="material-symbols-outlined link-icon">link</span>
              <div class="link-details">
                <p class="link-url">{{ nuevoElemento.link }}</p>
              </div>
            </div>
            <button class="remove-link" (click)="removeLink()">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="cancel-button" (click)="toggleModal()">Cancelar</button>
        <button class="save-button" (click)="guardarElemento()" [disabled]="!formValid || cargando">
          <span *ngIf="cargando" class="spinner-button"></span>
          <span *ngIf="!cargando">Guardar</span>
        </button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" *ngIf="showModal" (click)="toggleModal()"></div>
  <div class="button-container" style="position: fixed; bottom: 30px; left: 30px;" *ngIf="mural?.rol_usuario === 'administrador'">
    <button class="agregar-elemento" (click)="toggleModal()" (mouseenter)="showTooltip = true" (mouseleave)="showTooltip = false">
      <span class="material-symbols-outlined">add</span>
    </button>
    <div class="tooltip" [class.show]="showTooltip">
      Agregar contenido
    </div>
  </div>
</div>
